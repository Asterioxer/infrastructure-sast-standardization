name: SAST Policy Enforcement

on:
  workflow_call:

jobs:
  enforce-policy:
    name: Enforce SAST Policy
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout repo to access policy files
      - name: Checkout policy repository
        uses: actions/checkout@v4

      # Step 2: Download SAST results artifact
      - name: Download SAST results
        uses: actions/download-artifact@v4
        with:
          name: sast-results

      # Step 3: Load policy configuration
      - name: Load SAST policies
        id: load-policy
        run: |
          echo "üìú Loading SAST policy configuration"

          BLOCK_SEVERITIES=$(yq '.block_on_severity[]' policies/severity-thresholds.yml | tr '\n' ' ')
          WARN_SEVERITIES=$(yq '.warn_on_severity[]' policies/severity-thresholds.yml | tr '\n' ' ')

          echo "block_severities=$BLOCK_SEVERITIES" >> $GITHUB_OUTPUT
          echo "warn_severities=$WARN_SEVERITIES" >> $GITHUB_OUTPUT

          echo "üö® Blocking severities: $BLOCK_SEVERITIES"
          echo "‚ö†Ô∏è Warning severities: $WARN_SEVERITIES"

      # Step 4: Enforce policy based on findings
      - name: Enforce SAST policy
        run: |
          FINDINGS_COUNT=$(jq '.results | length' sast-results.json)

          echo "üîç Total SAST findings detected: $FINDINGS_COUNT"

          if [ "$FINDINGS_COUNT" -eq 0 ]; then
            echo "‚úÖ Policy passed: No SAST findings"
            exit 0
          fi

          echo "‚ùå Policy violation: SAST findings present"
          echo "üìå Refer to policies/severity-thresholds.yml for enforcement rules"
          exit 1
